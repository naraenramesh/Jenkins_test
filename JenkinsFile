pipeline {
 agent any

environment{

             PATH="$HOME/.yarn/bin:$HOME/.config/yarn/global/node_modules/.bin:$PATH"
             EXPECTED_NODE_VERSION="20.11.0"
}
 stages{

  stage('Install Dependencies'){
    steps{
      script{


         sh '''
         yarn_version=$(yarn --version)

          if [ !"$yarn_version" ]
                    then
                        echo "Yarn not found.$(yarn --version). Installing Yarn..."
                        curl -o- -L https://yarnpkg.com/install.sh | bash
                    else
                        echo "Yarn is already installed"
                    fi

                    # Verify Yarn version
                    yarn --version

            echo "Yarn installed"
node_version=$(node --version)

# Check if the current Node.js version matches the expected version
if [ "$node_version" != "v$EXPECTED_NODE_VERSION" ]
then
          if ! command -v nvm &> /dev/null
                    then
                                            echo "nvm not found. Installing nvm..."
                    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh | bash
                    fi
         export NVM_DIR="$HOME/.nvm"
                    [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

nvm --version
                                nvm install ${EXPECTED_NODE_VERSION}
            nvm use ${EXPECTED_NODE_VERSION}
echo "Node of version $(node --version) installed"
            fi

            yarn
            echo "Node modules created"
                          '''
 }
  }
  }
  stage('Run Tests'){
    steps{
    sh "yarn test"
    echo "Test results"
    }
  }
 }
}
